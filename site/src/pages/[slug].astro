---
import '@/styles/global.css';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
import Footer from '@/components/Footer.astro';
import { getCollection, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import { articleSchema, breadcrumbSchema } from '@/utils/schema';

export async function getStaticPaths() {
  const now = new Date();

  // Blog posts
  const posts = await getCollection('blog', ({ data }) =>
    data.pubDate.valueOf() <= now.valueOf()
  );

  // Guide articles (exclude hubs/index)
  const allGuides = await getCollection('guides', ({ data }) =>
    (!data.pubDate || data.pubDate.valueOf() <= now.valueOf()) && data.type === 'guide'
  );

  const blogPaths = posts.map((post) => ({
    params: { slug: post.id },
    props: { kind: 'blog' as const, post, entry: null as CollectionEntry<'guides'> | null, allPages: [] as CollectionEntry<'guides'>[] },
  }));

  const guidePaths = allGuides.map((entry) => {
    const slug = entry.id.split('/').pop()!;
    return {
      params: { slug },
      props: { kind: 'guide' as const, post: null as CollectionEntry<'blog'> | null, entry, allPages: allGuides },
    };
  });

  return [...blogPaths, ...guidePaths];
}

const { kind, post, entry, allPages } = Astro.props;

// Render the right content
const rendered = kind === 'guide' && entry
  ? await render(entry)
  : kind === 'blog' && post
    ? await render(post)
    : null;

const Content = rendered?.Content;
const headings = rendered?.headings || [];

// Build page metadata
let title = '';
let description = '';
let image: string | undefined;
let pageUrl = '/';
let schemas: Record<string, unknown>[] = [];
let readingTime: string | undefined;
let parentHubTitle: string | undefined;
let parentHubUrl: string | undefined;

if (kind === 'guide' && entry) {
  const slug = entry.id.split('/').pop()!;
  title = entry.data.title;
  description = entry.data.description;
  image = entry.data.image;
  readingTime = entry.data.readingTime;
  pageUrl = `/${slug}/`;

  const pubDate = entry.data.pubDate ? new Date(entry.data.pubDate).toISOString() : undefined;

  // Find parent hub
  if (entry.data.parent) {
    const allEntries = await getCollection('guides');
    const hub = allEntries.find((p) => p.id === `${entry.data.parent}/index`);
    if (hub) {
      parentHubTitle = hub.data.title;
      parentHubUrl = `/guides/${hub.id.replace(/\/index$/, '')}`;
    }
  }

  const breadcrumbItems = [{ name: 'Accueil', url: '/' }];
  if (parentHubTitle && parentHubUrl) {
    breadcrumbItems.push({ name: parentHubTitle, url: parentHubUrl });
  }
  breadcrumbItems.push({ name: title, url: pageUrl });

  schemas = [
    articleSchema({ title, description, url: pageUrl, image, datePublished: pubDate }),
    breadcrumbSchema(breadcrumbItems),
  ];
} else if (kind === 'blog' && post) {
  title = post.data.title;
  description = post.data.description;
  image = post.data.image;
  pageUrl = `/${post.id}/`;

  schemas = [
    articleSchema({ title, description, url: pageUrl, image, datePublished: post.data.pubDate.toISOString(), author: post.data.author }),
    breadcrumbSchema([{ name: 'Accueil', url: '/' }, { name: title, url: pageUrl }]),
  ];
}

---

<BaseLayout
  title={`${title} | Cristallina`}
  description={description}
  ogImage={image}
  jsonLd={schemas}
>
  <Navbar />

  <main class="pt-32 pb-16">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumb -->
      <nav class="flex items-center gap-2 text-sm text-text-muted mb-8" aria-label="Fil d'ariane">
        <a href="/" class="hover:text-primary transition-colors cursor-pointer">Accueil</a>
        {parentHubTitle && parentHubUrl && (
          <>
            <span>/</span>
            <a href={parentHubUrl} class="hover:text-primary transition-colors cursor-pointer">
              {parentHubTitle}
            </a>
          </>
        )}
        <span>/</span>
        <span class="text-text-secondary">{title}</span>
      </nav>

      <!-- Header -->
      <header class="mb-10">
        {readingTime && (
          <span class="text-xs text-text-muted mb-4 block">{readingTime} de lecture</span>
        )}
        <h1 class="font-display font-800 text-display leading-[1.1] mb-4 tracking-tight">
          {title}
        </h1>
        <p class="text-body-lg text-text-secondary leading-relaxed">
          {description}
        </p>
      </header>

      <!-- Hero Image -->
      {image && (
        <div class="mb-10 rounded-card overflow-hidden border border-border">
          <img src={image} alt={title} class="w-full h-auto object-cover aspect-video" width="1200" height="675" loading="eager" />
        </div>
      )}

      <!-- Content -->
      <article class="prose-custom">
        {Content && <Content />}
      </article>
    </div>
  </main>

  <Footer />
</BaseLayout>
